/* @(#)test_rcmnorm.c
   gcc  -Wall -O3 -funroll-all-loops test_rcmnorm.c rtnorm.c rcmnorm.c -I/usr/local/gsl/include/ -L/usr/local/gsl/lib -lgsl -lgslcblas
*/

#include <assert.h>
#include <stdio.h>
#include "gsl_ext.h"

extern int trace_interval;

/*
static
double row_vector[1000];

gsl_matrix * read_matrix_bmt(FILE * fin, int r)
{
  char row[1024];
  char * read;
  int c;
  
  gsl_matrix * mat;
  
  if (feof(fin)) {
    
    mat = gsl_matrix_alloc
  }
  
    read = fscanf(row, 1024, fin);
  
}

gsl_vector * read_vector_bmt(FILE * fin)
{
}
*/

void test_rect0(gsl_matrix ** COV, gsl_vector ** mean,
                gsl_matrix ** B, gsl_vector ** b, gsl_vector **x0)
{
  double low[] = {1, 0.5};
  double high[] = {2, 1.5};
  double C_data[] = {1.0, 4/5.0,
                     4/5.0, 1.0};
  double m_data[] = {0, 1.0};
  gsl_vector_view low_v = gsl_vector_view_array(low, 2);
  gsl_vector_view high_v = gsl_vector_view_array(high, 2);
  gsl_matrix_view tmp_m;
  gsl_vector_view tmp_v;
  
  *COV = gsl_matrix_alloc(2,2);
  tmp_m = gsl_matrix_view_array(C_data, 2, 2);
  gsl_matrix_memcpy(*COV, &tmp_m.matrix);
  *mean = gsl_vector_alloc(2);
  tmp_v = gsl_vector_view_array(m_data, 2);
  gsl_vector_memcpy(*mean, &tmp_v.vector);
  gsl_rectangle_alloc(&low_v.vector, &high_v.vector, B, b, x0);
  printf("B = -----\n");
  gsl_matrix_table(stdout, *B);
  printf("b = -----\n");
  gsl_vector_table(stdout, *b);
}

void test_rect1(gsl_matrix ** COV, gsl_vector ** mean,
                gsl_matrix ** B, gsl_vector ** b, gsl_vector ** x0)
{
  /*
   * -x1 <= 1
   * -x2 <= -0.5
   *  x1 <= 1
   *  x2 <= 1.5
   *  
   */
  double low[] = {-1, 0.5};
  double high[] = {1, 1.5};
  double C_data[] = {1.0, 4/5.0,
                     4/5.0, 1.0};
  double m_data[] = {0, 1.0};    
  gsl_vector_view low_v = gsl_vector_view_array(low, 2);
  gsl_vector_view high_v = gsl_vector_view_array(high, 2);
  gsl_matrix_view tmp_m;
  gsl_vector_view tmp_v;
  
  *COV = gsl_matrix_alloc(2,2);
  tmp_m = gsl_matrix_view_array(C_data, 2, 2);
  gsl_matrix_memcpy(*COV, &tmp_m.matrix);
  *mean = gsl_vector_alloc(2);
  tmp_v = gsl_vector_view_array(m_data, 2);
  gsl_vector_memcpy(*mean, &tmp_v.vector);
  gsl_rectangle_alloc(&low_v.vector, &high_v.vector, B, b, x0);
  printf("B = -----\n");
  gsl_matrix_table(stdout, *B);
  printf("b = -----\n");
  gsl_vector_table(stdout, *b);
}

void test_rect2(gsl_matrix ** COV, gsl_vector ** mean,
                gsl_matrix ** B, gsl_vector ** b, gsl_vector ** x0)
{
  /*
   * constraints taken from Bm.bmt and bv.bmt
   * 
   */
  double low[] = {-10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -0.000000,
                  0.000000,
                  -10.000000,
                  0.000000,
                  -10.000000,
                  0.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  -10.000000,
                  0.000000,
                  0.000000,
                  0.800000,
                  0.800000,
                  0.800000
  };
  double high[] = {10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   0.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   10.000000,
                   1.500000,
                   1.500000,
                   1.500000
  };
  /* covariance matrix */
  double C_data[] = {0.353976, 0.006402, 0.008896, -0.028115, -0.218341, 0.014405, 0.000139, 0.001107, 0.205115, -0.024037, 0.012296, 0.765456, -0.001945, 0.026669, 0.005819, 0.000659, -0.015125, -0.004006, 0.000671, -0.000075, 0.004807, -0.001916, 0.002349, -0.026810, 0.010798, -0.368290, 
0.006402, 0.184536, 0.051219, 0.025466, 0.006314, 0.019478, -0.001218, -0.003624, 0.009485, 0.000933, 0.018607, -0.133589, -0.007796, 0.057120, -0.003212, -0.005136, 0.018213, -0.015716, 0.013457, 0.023825, -0.004929, 0.000635, -0.000882, -0.008281, -0.277615, -0.076499, 
0.008896, 0.051219, 2.111823, 0.043799, -0.011807, 0.011187, -0.064763, 0.004719, 8.171509, -0.521006, 0.034805, 1.159086, 0.034256, 0.628762, 0.061595, 0.011158, -0.027173, -0.065488, 0.003538, -0.042794, 0.012533, 0.005916, -0.002056, -0.049415, -0.070654, 0.034096, 
-0.028115, 0.025466, 0.043799, 0.371912, 0.001610, -0.036324, -0.001162, -0.002692, -0.639069, 0.035267, 0.004773, 0.555100, -0.006282, -0.042865, -0.054823, 0.010232, 0.025603, -0.017192, 0.013250, -0.032221, 0.037205, 0.000009, -0.000376, 0.001403, -0.124839, -0.010968, 
-0.218341, 0.006314, -0.011807, 0.001610, 0.237984, 0.004918, -0.000115, -0.000975, -0.813960, 0.036756, -0.000629, -0.627933, 0.003271, -0.082606, -0.022067, -0.000372, 0.010265, 0.002455, 0.003696, 0.007910, -0.006581, 0.002093, -0.002167, 0.012570, -0.015826, 0.081266, 
0.014405, 0.019478, 0.011187, -0.036324, 0.004918, 0.645144, -0.000446, -0.000034, -0.245405, -0.012525, 0.010977, -0.751909, 0.005168, -0.039188, -0.025812, 0.000650, 0.002256, 0.002913, 0.009092, 0.011924, -0.009633, 0.003184, -0.002622, -0.014928, -0.025468, -0.218318, 
0.000139, -0.001218, -0.064763, -0.001162, -0.000115, -0.000446, 0.002684, -0.000050, -0.129996, 0.009404, -0.000476, -0.034552, -0.001018, -0.007714, -0.001649, -0.000094, 0.000350, 0.002168, 0.000225, 0.000904, 0.000075, -0.000235, 0.000048, 0.000974, 0.001804, -0.000519, 
0.001107, -0.003624, 0.004719, -0.002692, -0.000975, -0.000034, -0.000050, 0.002688, 0.248639, -0.019017, 0.003497, 0.020122, 0.001217, 0.020580, 0.005669, 0.000433, -0.020368, -0.000329, 0.000314, -0.018689, 0.000347, -0.000012, 0.000052, -0.006619, -0.003791, -0.001178, 
0.205115, 0.009485, 8.171509, -0.639069, -0.813960, -0.245405, -0.129996, 0.248639, 1198.947175, -72.266599, -0.247241, -3.698543, 7.160872, 85.778097, 13.365874, -1.301528, -2.062252, -0.048426, -3.804221, -6.349635, -1.814897, 0.027551, -0.009433, -3.280067, -3.662736, 10.203455, 
-0.024037, 0.000933, -0.521006, 0.035267, 0.036756, -0.012525, 0.009404, -0.019017, -72.266599, 5.178723, -0.107219, -0.102415, -0.614740, -3.868255, -0.653605, 0.039816, 0.148771, -0.019474, 0.198378, 0.396711, 0.120115, -0.005664, -0.002351, 0.346006, 0.261073, -0.384418, 
0.012296, 0.018607, 0.034805, 0.004773, -0.000629, 0.010977, -0.000476, 0.003497, -0.247241, -0.107219, 0.109859, -0.198833, 0.000322, 0.068445, -0.045034, 0.007088, -0.047032, -0.024806, 0.037785, 0.011685, 0.007520, -0.000560, -0.000587, -0.113996, 0.001231, -0.135936, 
0.765456, -0.133589, 1.159086, 0.555100, -0.627933, -0.751909, -0.034552, 0.020122, -3.698543, -0.102415, -0.198833, 187.761170, -0.018922, -1.783713, -1.256224, -0.235260, -1.037467, -0.203250, -1.142238, -0.789727, 0.733169, -0.010010, 0.169629, 0.378947, 2.425395, -0.204910, 
-0.001945, -0.007796, 0.034256, -0.006282, 0.003271, 0.005168, -0.001018, 0.001217, 7.160872, -0.614740, 0.000322, -0.018922, 0.118360, 0.172704, 0.047348, 0.002704, -0.001479, 0.016190, -0.024528, -0.044340, -0.018677, 0.001466, 0.000729, -0.031997, -0.005232, 0.028657, 
0.026669, 0.057120, 0.628762, -0.042865, -0.082606, -0.039188, -0.007714, 0.020580, 85.778097, -3.868255, 0.068445, -1.783713, 0.172704, 9.086468, 1.246350, -0.149156, -0.243573, -0.123145, -0.228944, -0.404273, -0.091874, -0.007740, -0.008251, -0.301593, -0.153064, 0.786521, 
0.005819, -0.003212, 0.061595, -0.054823, -0.022067, -0.025812, -0.001649, 0.005669, 13.365874, -0.653605, -0.045034, -1.256224, 0.047348, 1.246350, 1.391246, -0.036225, -0.065819, -0.029622, -0.137728, -0.176097, -0.058069, -0.000323, 0.002342, -0.137455, -0.077809, 0.213730, 
0.000659, -0.005136, 0.011158, 0.010232, -0.000372, 0.000650, -0.000094, 0.000433, -1.301528, 0.039816, 0.007088, -0.235260, 0.002704, -0.149156, -0.036225, 0.258991, 0.003474, 0.005338, 0.013325, 0.007430, 0.006015, 0.000135, 0.000578, -0.002531, 0.011562, -0.023495, 
-0.015125, 0.018213, -0.027173, 0.025603, 0.010265, 0.002256, 0.000350, -0.020368, -2.062252, 0.148771, -0.047032, -1.037467, -0.001479, -0.243573, -0.065819, 0.003474, 0.420334, 0.015785, 0.002751, 0.142055, -0.002845, 0.000809, -0.001027, 0.081395, 0.025575, 0.034851, 
-0.004006, -0.015716, -0.065488, -0.017192, 0.002455, 0.002913, 0.002168, -0.000329, -0.048426, -0.019474, -0.024806, -0.203250, 0.016190, -0.123145, -0.029622, 0.005338, 0.015785, 0.268896, -0.002167, 0.000977, -0.002306, 0.001374, 0.000095, 0.034758, 0.020654, 0.026067, 
0.000671, 0.013457, 0.003538, 0.013250, 0.003696, 0.009092, 0.000225, 0.000314, -3.804221, 0.198378, 0.037785, -1.142238, -0.024528, -0.228944, -0.137728, 0.013325, 0.002751, -0.002167, 0.543060, 0.036684, 0.011222, -0.000177, -0.000586, -0.021594, -0.007689, -0.082922, 
-0.000075, 0.023825, -0.042794, -0.032221, 0.007910, 0.011924, 0.000904, -0.018689, -6.349635, 0.396711, 0.011685, -0.789727, -0.044340, -0.404273, -0.176097, 0.007430, 0.142055, 0.000977, 0.036684, 0.680236, 0.006950, -0.000460, -0.000851, 0.027369, 0.069224, -0.071802, 
0.004807, -0.004929, 0.012533, 0.037205, -0.006581, -0.009633, 0.000075, 0.000347, -1.814897, 0.120115, 0.007520, 0.733169, -0.018677, -0.091874, -0.058069, 0.006015, -0.002845, -0.002306, 0.011222, 0.006950, 0.516834, -0.001640, 0.000921, 0.003998, 0.020689, -0.017180, 
-0.001916, 0.000635, 0.005916, 0.000009, 0.002093, 0.003184, -0.000235, -0.000012, 0.027551, -0.005664, -0.000560, -0.010010, 0.001466, -0.007740, -0.000323, 0.000135, 0.000809, 0.001374, -0.000177, -0.000460, -0.001640, 0.001179, -0.000422, -0.000778, -0.001770, -0.001184, 
0.002349, -0.000882, -0.002056, -0.000376, -0.002167, -0.002622, 0.000048, 0.000052, -0.009433, -0.002351, -0.000587, 0.169629, 0.000729, -0.008251, 0.002342, 0.000578, -0.001027, 0.000095, -0.000586, -0.000851, 0.000921, -0.000422, 0.001295, -0.001061, 0.003236, -0.005198, 
-0.026810, -0.008281, -0.049415, 0.001403, 0.012570, -0.014928, 0.000974, -0.006619, -3.280067, 0.346006, -0.113996, 0.378947, -0.031997, -0.301593, -0.137455, -0.002531, 0.081395, 0.034758, -0.021594, 0.027369, 0.003998, -0.000778, -0.001061, 0.298917, 0.002185, 0.168205, 
0.010798, -0.277615, -0.070654, -0.124839, -0.015826, -0.025468, 0.001804, -0.003791, -3.662736, 0.261073, 0.001231, 2.425395, -0.005232, -0.153064, -0.077809, 0.011562, 0.025575, 0.020654, -0.007689, 0.069224, 0.020689, -0.001770, 0.003236, 0.002185, 5.056455, 0.046464, 
-0.368290, -0.076499, 0.034096, -0.010968, 0.081266, -0.218318, -0.000519, -0.001178, 10.203455, -0.384418, -0.135936, -0.204910, 0.028657, 0.786521, 0.213730, -0.023495, 0.034851, 0.026067, -0.082922, -0.071802, -0.017180, -0.001184, -0.005198, 0.168205, 0.046464, 4.020390 
};
  double m_data[] = {0.019632,
                     0.093793,
                     0.355914,
                     0.361220,
                     0.071677,
                     0.333222,
                     -0.031589,
                     -0.007067,
                     -9.440332,
                     1.068743,
                     0.126660,
                     -0.977560,
                     0.042868,
                     -0.712490,
                     0.049071,
                     0.073590,
                     -0.086822,
                     0.106114,
                     0.114993,
                     -0.031723,
                     0.055453,
                     0.005152,
                     0.010234,
                     0.922950,
                     0.993084,
                     0.933150
  };
  
  gsl_vector_view low_v = gsl_vector_view_array(low, 26);
  gsl_vector_view high_v = gsl_vector_view_array(high, 26);
  gsl_matrix_view tmp_m;
  gsl_vector_view tmp_v;
  
  *COV = gsl_matrix_alloc(26,26);
  tmp_m = gsl_matrix_view_array(C_data, 26, 26);
  gsl_matrix_memcpy(*COV, &tmp_m.matrix);
  *mean = gsl_vector_alloc(26);
  tmp_v = gsl_vector_view_array(m_data, 26);
  gsl_vector_memcpy(*mean, &tmp_v.vector);
  gsl_rectangle_alloc(&low_v.vector, &high_v.vector, B, b, x0);
  printf("B = -----\n");
  gsl_matrix_table(stdout, *B);
  printf("b = -----\n");
  gsl_vector_table(stdout, *b);
}

int main(void)
{
  const gsl_rng_type * T;
  gsl_rng * r;
  gsl_matrix *B, * COV;
  gsl_vector  * b, * mean;
  gsl_vector * x;
  gsl_rcmnorm_workspace_t w;
  int i, j = 0;
  const int iter = 100000;
  int gsl_ret;
  
  gsl_rng_env_setup();
  T = gsl_rng_default;
  r = gsl_rng_alloc (T);

  //test_rect0(&COV, &mean, &B, &b, &x);
  //test_rect1(&COV, &mean, &B, &b, &x);
  test_rect2(&COV, &mean, &B, &b, &x);

  gsl_ret = gsl_rcmnorm_init(mean, 1.0,
                             COV, B, b, x, &w);

#define PRINT_A_D
#ifdef PRINT_A_D  
  printf("--- LLT --- \n");
  gsl_matrix_table(stdout, w.LLT);
  printf("--- D --- \n");
  gsl_matrix_table(stdout, w.D);
  printf("--- z mean ---\n");
  gsl_vector_table(stdout, w.alpha);
#endif
  trace_interval = 1;
  for (i = 0; i < iter; i++) {
    gsl_rcmnorm_draw(r, &w, x);
    if (i==10) {
      printf("...\n");
      trace_interval = 0;
    }
    else if (i < 10 || i >= iter-10) {
      trace_interval = 1;
      printf("x(%d) = ", i);
      for (j = 0; j < x->size; j++)
        printf(" %g", gsl_vector_get(x,j));
      printf("\n");
    }
  }
  gsl_rcmnorm_free(&w);
  gsl_vector_free(mean);
  gsl_vector_free(b);
  gsl_matrix_free(COV);
  gsl_matrix_free(B);
  gsl_vector_free(x);
  return 0;
}


