//////////////////////////////////////////////////////////////////////////////
// FILE    : _special.tol
// PURPOSE : Funciones especiales
//////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
// FUNCTIONS
//////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
Date ComNotNullN(Serie ser, Real rea)
//////////////////////////////////////////////////////////////////////////////
{
  TimeSet serTS     = SerTms(ser);
  Set     dateNoNul = Dates(serTS, First(ser), Last(ser));
  Date    fecref    = If(Eq(Sign(rea),1), dateNoNul[1],
                                        dateNoNul[Card(dateNoNul)]);
  Date    fecprop   = Succ(fecref, serTS, value-Sign(rea));
  If(Belong(fecprop,serTS), fecprop,
                            If(Eq(Sign(rea),1), TheBegin, TheEnd))
};
//////////////////////////////////////////////////////////////////////////////
PutDescription("
Devuelve la fecha del n-esimo elemento no nulo de una serie. Si contamos desde
el final de la serie n debe ser negativo, por ejemplo, -1 indica la ultima
ocurrencia de un valor no nulo.",
ComNotNullN);
//////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
Date ComSetMinDate(Set setDate)
//////////////////////////////////////////////////////////////////////////////
{
  If(EQ(Card(setDates),1),setDate[1],Eval("Min("+DatesList(setDate)+");"))  
};
//////////////////////////////////////////////////////////////////////////////
PutDescription(
"Devuelve la menor de las fechas del conjunto de fechas que recibe",
ComSetMinDate);
//////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
Date ComSetMaxDate(Set setDate)
//////////////////////////////////////////////////////////////////////////////
{
  If(EQ(Card(setDate),1),setDate[1],Eval("Max("+DatesList(setDate)+");"))
};
//////////////////////////////////////////////////////////////////////////////                            
PutDescription(
"Devuelve la mayor de las fechas del conjunto de fechas que recibe",
ComSetMaxDate);
//////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
Date ComFirstEqual(Serie ser, Real rea)
//////////////////////////////////////////////////////////////////////////////
{
  Date ini            = First(ser);
  TimeSet fech        = Dating(ser);
  Serie valorSer      = CalInd(C, fech)*rea;
  Serie dif           = ser-valorSer;
  Serie noNulo        = Not(dif);
  Date firstDateEqual = FirstNotEqual(noNulo,ini,0);
  firstDateEqual
};
//////////////////////////////////////////////////////////////////////////////
PutDescription(
"Devuelve la fecha de la serie que tiene ese valor",
ComFirstEqual);
//////////////////////////////////////////////////////////////////////////////
