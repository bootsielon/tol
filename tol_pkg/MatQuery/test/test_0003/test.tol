/* -*- mode: C++ -*- */
//////////////////////////////////////////////////////////////////////////////
// FILE   : test.tol
// PURPOSE: Package MatQuery test
//////////////////////////////////////////////////////////////////////////////

Text email_ = "vdebuen@tol-project.org"; 
Text link_ = ""; 
Text summary_ = "checking matrix row selection of unknown values";

//#Require MatQuery;
//#Embed "../../../_embed_all.tol";

//Write here the initial test TOL code if needed
Real numErr0 = Copy(NError);
Real numWar0 = Copy(NWarning);

Real t1 = Copy(Time);
Real rndSeed = 0;
Real m = 300;
Real n = 10;

VMatrix unk.match = LE(Rand(m,n,0,1),Rand(m,n,1,1)*.20);
VMatrix M = IfVMat(unk.match, Rand(m,n,1,1)*?, Rand(m,n,-10,10));

VMatrix M.unk = Min(IsUnknown(M)*Rand(n,1,1,1), Rand(m,1,1,1));

VMatrix M.rows.known = Pack(Not(IsUnknown(M)*Rand(n,1,1,1)));
VMatrix M.rows.unknown = Pack(Not(M.rows.known));
VMatrix M.rows.known_= MatQuery::MatchRowsFullKnown(M);

VMatrix unk.match.1 = LE(Rand(m,1,0,1),Rand(m,1,1,1)*.20);
VMatrix M1 = IfVMat(unk.match.1, Rand(m,1,1,1)*?, Rand(m,1,-10,10));

VMatrix unk.match.1_ = MatQuery::MatchRowsWithValue(M1,?);
Real ok.1 = VMatMax(Abs(unk.match.1-unk.match.1))==0;

Set sel.known = MatQuery::SelectMatch(Not(unk.match.1_));

VMatrix extract.known = SubRow(M1, sel.known);

Real ok.2 = VMatSum(IsUnknown(extract.known))==0;
Real ok.3 = VRows(extract.known)==m-VMatSum(unk.match.1);


Real numErr1 = Copy(NError);
Real numWar1 = Copy(NWarning);

Set partialResults_ = [[numErr0, numErr1, 
                        ok.1, ok.2, ok.3]];

//This is a messure of the success of the test 
Real quality_ = And(numErr1 == numErr0, 
                    numWar1 <= numWar0, 
                    ok.1, ok.2, ok.3);

//Return the results 
Set resultStr_ = @strTestStatus(summary_, link_, quality_,
                  "Partial results = "<<partialResults_,
                  "NO DBServerType", "NO DBServerHost", "NO DBAlias",
                  email_);
WriteLn(""<<resultStr_);
resultStr_;

/* */

